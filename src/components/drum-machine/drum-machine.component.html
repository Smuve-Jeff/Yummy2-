<div class="w-full h-full flex flex-col gap-4 p-4 border-2 bg-black/80 backdrop-blur-sm"
  [class]="'border-' + theme().primary + '-500/50'"
  [class]="'text-' + theme().primary + '-400'">

  <!-- Header / Controls -->
  <div class="flex flex-wrap items-center justify-between gap-4 p-2 border-b border-inherit">
    <h2 class="text-2xl font-bold">[ DRUM MACHINE ]</h2>

    <div class="flex items-center gap-4">
      <div class="flex items-center gap-2">
        <span>BPM:</span>
        <input type="number" [value]="bpm()" (input)="handleBpmInput($event)" class="w-16 bg-transparent border border-inherit p-1 text-center">
        <div class="flex flex-col gap-1">
             <button (click)="changeBpm(1)" class="px-1 border border-inherit text-xs hover:text-black hover:bg-current">+</button>
             <button (click)="changeBpm(-1)" class="px-1 border border-inherit text-xs hover:text-black hover:bg-current">-</button>
        </div>
      </div>

      <button (click)="togglePlay()" class="w-12 h-12 flex items-center justify-center border-2 text-xl hover:text-black hover:bg-current transition-colors"
        [class]="'border-' + theme().primary + '-500'">
        @if (isPlaying()) { <span>[ || ]</span> } @else { <span>[ &gt; ]</span> }
      </button>

      <button (click)="reset()" class="p-2 border border-inherit hover:text-black hover:bg-current text-sm">
        [ CLEAR ]
      </button>
    </div>

    <div class="flex items-center gap-2">
       <button (click)="toggleRecording()" class="p-2 border border-inherit hover:text-black hover:bg-current text-sm flex items-center gap-2"
         [class.text-red-500]="isRecording()"
         [class.border-red-500]="isRecording()">
         <span class="w-3 h-3 rounded-full bg-current" [class.animate-pulse]="isRecording()"></span>
         {{ isRecording() ? 'STOP REC' : 'REC WAV' }}
       </button>

       @if (recordedUrl()) {
         <button (click)="downloadRecording()" class="p-2 border border-inherit hover:text-black hover:bg-current text-sm">
           [ DOWNLOAD ]
         </button>
       }
    </div>
  </div>

  <!-- Sequencer Grid -->
  <div class="flex-grow overflow-y-auto space-y-2">
    @for (track of tracks(); track track.name; let i = $index) {
      <div class="flex items-center gap-2 p-1 border border-transparent hover:border-inherit transition-colors rounded bg-black/40">
        <!-- Track Controls -->
        <div class="w-32 flex flex-col gap-1 p-1 text-xs border-r border-inherit/30">
          <div class="flex justify-between items-center">
            <span class="font-bold">{{ track.name }}</span>
            <div class="flex gap-1">
               <button (click)="toggleMute(i)" class="px-1 border border-inherit" [class.bg-red-900]="track.mute" [class.text-white]="track.mute">M</button>
               <button (click)="toggleSolo(i)" class="px-1 border border-inherit" [class.bg-yellow-600]="track.solo" [class.text-white]="track.solo">S</button>
            </div>
          </div>
          <div class="flex items-center gap-1">
             <span>V</span>
             <input type="range" min="0" max="1" step="0.01" [value]="track.volume" (input)="onVolumeChange(i, $event)" class="w-full h-1">
          </div>
           <div class="flex items-center gap-1">
             <span>P</span>
             <input type="range" min="-1" max="1" step="0.1" [value]="track.pan" (input)="onPanChange(i, $event)" class="w-full h-1">
          </div>
           <div class="flex items-center gap-1">
             <span>T</span>
             <input type="range" min="0.5" max="2" step="0.1" [value]="track.pitch" (input)="onPitchChange(i, $event)" class="w-full h-1">
          </div>
        </div>

        <!-- Steps -->
        <div class="flex-grow grid grid-cols-16 gap-1">
          @for (step of track.steps; track $index; let s = $index) {
             <button
               (click)="toggleStep(i, s)"
               class="w-full aspect-square border border-inherit/20 transition-all duration-75"
               [class.bg-current]="step"
               [class.opacity-50]="!step"
               [class.scale-110]="isPlaying() && currentStep() === s"
               [class.border-white]="isPlaying() && currentStep() === s"
               [class.bg-white]="isPlaying() && currentStep() === s && step"
               [style.background-color]="step ? '' : (s % 4 === 0 ? 'rgba(255,255,255,0.1)' : 'transparent')"
               >
             </button>
          }
        </div>
      </div>
    }
  </div>

  <div class="text-xs text-center opacity-50">
     [ STUDIO QUALITY SYNTHESIS ENGINE ACTIVE ]
  </div>

</div>
