<div class="w-full p-4 flex flex-col gap-4 relative min-h-[600px]"
  [class]="'text-' + theme().neutral + '-200'"
  [class]="'bg-' + theme().purple + '-900/50'"
  [class]="'border border-' + theme().purple + '-500/30'">
  <h2 class="text-center text-lg" [class]="'text-' + theme().purple + '-400'">[ AURA VIDEO LAB ]</h2>

  @if (error()) {
    <div class="bg-red-900/50 text-red-300 p-3 text-center border border-red-500 animate-fade-in">
      {{ error() }}
    </div>
  }

  <!-- TABS/MODES -->
  <div class="flex gap-4 border-b pb-2 mb-2" [class]="'border-' + theme().purple + '-500/30'">
      <div class="flex-1 grid grid-cols-2 gap-4">
        <!-- Editor Column -->
        <div class="flex flex-col gap-4">
             <!-- Camera & Recording -->
            <div class="flex flex-col gap-4 p-4 border"
            [class]="'border-' + theme().purple + '-500/20'">
            <h3 class="text-base" [class]="'text-' + theme().purple + '-300'">// CAMERA & RECORDING</h3>
            <div class="flex-grow flex items-center justify-center border-2 border-dashed p-2 min-h-[200px] overflow-hidden bg-black relative"
                [class]="'border-' + theme().purple + '-700/50'">
                <video #liveVideoPreview class="max-w-full max-h-full object-contain" autoplay muted playsinline></video>
                @if (!isCameraActive()) {
                <span class="absolute text-sm" [class]="'text-' + theme().neutral + '-500'">[ Camera Off ]</span>
                }
                @if (isRecording()) {
                <span class="absolute top-2 left-2 text-red-500 animate-pulse text-sm flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-red-500"></span> REC: {{ formatTime(recordingTime()) }}
                </span>
                }
            </div>

            <div class="flex gap-2">
                <button (click)="toggleCamera()"
                class="flex-grow px-4 py-2 border-2 text-sm"
                [class]="'border-' + theme().purple + '-500 bg-' + theme().purple + '-800 text-' + theme().purple + '-300 hover:bg-' + theme().purple + '-500 hover:text-black'"
                [disabled]="isRecording()">
                {{ isCameraActive() ? '[ DISABLE CAMERA ]' : '[ ENABLE CAMERA ]' }}
                </button>
            </div>
            <div class="flex gap-2">
                <button (click)="startRecording()"
                    class="flex-grow px-4 py-2 border-2 text-sm"
                    [class]="'border-' + theme().primary + '-500 bg-' + theme().primary + '-800 text-' + theme().primary + '-300 hover:bg-' + theme().primary + '-500 hover:text-black'"
                    [disabled]="isRecording() || !isCameraActive()">
                    {{ isRecording() ? '[ RECORDING... ]' : '[ START RECORDING ]' }}
                </button>
                <button (click)="stopRecording()"
                    class="px-4 py-2 border-2 text-sm"
                    [class]="'border-' + theme().red + '-500 bg-' + theme().red + '-800 text-' + theme().red + '-300 hover:bg-' + theme().red + '-500 hover:text-black'"
                    [disabled]="!isRecording()">
                    [ STOP ]
                </button>
            </div>
            </div>

            <!-- AI Video Generation -->
            <div class="flex flex-col gap-4 p-4 border"
            [class]="'border-' + theme().purple + '-500/20'">
            <h3 class="text-base" [class]="'text-' + theme().purple + '-300'">// AI VIDEO GENERATION</h3>
            @if (imageForVideoGeneration()) {
                <div class="flex flex-col items-center gap-2">
                <h4 class="text-sm" [class]="'text-' + theme().neutral + '-400'">// IMAGE INPUT FROM EDITOR</h4>
                <img [src]="imageForVideoGeneration()!" alt="Image from editor" class="w-24 h-24 object-cover border"
                    [class]="'border-' + theme().neutral + '-600'">
                </div>
            }
            <textarea
                [value]="videoPrompt()"
                (input)="videoPrompt.set($event.target.value)"
                placeholder="Video Prompt..."
                rows="3"
                class="w-full p-2 text-sm focus:ring-500 resize-y bg-opacity-50 border"
                [class]="'bg-' + theme().purple + '-800 border-' + theme().purple + '-500/50 text-' + theme().neutral + '-200 focus:border-' + theme().purple + '-500'"
                [disabled]="isGeneratingVideo() || !isAiAvailable()"></textarea>

            <div class="flex flex-col gap-2 mt-2">
                <button (click)="generateVideo(false)"
                class="flex-grow px-4 py-2 border-2 text-sm"
                [class]="'border-' + theme().purple + '-500 bg-' + theme().purple + '-800 text-' + theme().purple + '-300 hover:bg-' + theme().purple + '-500 hover:text-black'"
                [disabled]="!videoPrompt() || isGeneratingVideo() || !isAiAvailable()">
                {{ isGeneratingVideo() ? '[ GENERATING... ]' : '[ GENERATE FROM PROMPT ]' }}
                </button>
                @if (imageForVideoGeneration()) {
                <button (click)="generateVideo(true)"
                    class="flex-grow px-4 py-2 border-2 text-sm"
                    [class]="'border-' + theme().purple + '-500 bg-' + theme().purple + '-800 text-' + theme().purple + '-300 hover:bg-' + theme().purple + '-500 hover:text-black'"
                    [disabled]="!videoPrompt() || isGeneratingVideo() || !isAiAvailable()">
                    {{ isGeneratingVideo() ? '[ GENERATING... ]' : '[ GENERATE FROM IMAGE + PROMPT ]' }}
                </button>
                }
            </div>

            @if (generationProgressMessage()) {
                <p class="text-sm mt-2 text-center animate-pulse" [class]="'text-' + theme().neutral + '-400'">{{ generationProgressMessage() }}</p>
            }
            </div>
        </div>

        <!-- Library & Sequencer Column -->
        <div class="flex flex-col gap-4">
             <!-- CLIP LIBRARY -->
             <div class="flex-1 flex flex-col p-4 border min-h-[300px]" [class]="'border-' + theme().purple + '-500/20'">
                 <div class="flex justify-between items-center mb-2">
                     <h3 class="text-base" [class]="'text-' + theme().purple + '-300'">// CLIP LIBRARY ({{clips().length}})</h3>
                     <button (click)="createSequenceFromAll()" class="text-xs hover:underline">[ Add All to Seq ]</button>
                 </div>

                 <div class="flex-1 overflow-y-auto space-y-2 max-h-[400px]">
                     <div *ngFor="let clip of clips()" class="flex items-center gap-2 p-2 rounded bg-black/20 border" [class]="'border-' + theme().neutral + '-700'">
                         <video [src]="clip.url" class="w-16 h-12 object-cover bg-black"></video>
                         <div class="flex-1 min-w-0">
                             <div class="text-sm font-bold truncate">{{ clip.name }}</div>
                             <div class="text-xs opacity-50">{{ clip.type }}</div>
                         </div>
                         <button (click)="addToSequence(clip)" class="px-2 py-1 text-xs border rounded hover:bg-white/10" [class]="'border-' + theme().purple + '-500 text-' + theme().purple + '-400'">+ SEQ</button>
                     </div>
                     <div *ngIf="clips().length === 0" class="text-center opacity-40 text-sm py-4">No clips yet. Record or Generate one.</div>
                 </div>
             </div>

             <!-- SEQUENCER -->
             <div class="flex-1 flex flex-col p-4 border min-h-[300px]" [class]="'border-' + theme().purple + '-500/20'">
                <h3 class="text-base mb-2" [class]="'text-' + theme().purple + '-300'">// SEQUENCER</h3>

                <div class="relative w-full aspect-video bg-black border mb-4" [class]="'border-' + theme().neutral + '-700'">
                    <video #sequencePlayer class="w-full h-full object-contain"></video>
                    <div *ngIf="!isPlayingSequence()" class="absolute inset-0 flex items-center justify-center opacity-50">[ STOPPED ]</div>
                </div>

                <div class="flex gap-2 mb-4">
                    <button (click)="playSequence()" [disabled]="sequencerClips().length === 0"
                        class="flex-1 px-4 py-2 border font-bold"
                        [class]="'border-' + theme().accent + '-500 text-' + theme().accent + '-400 hover:bg-' + theme().accent + '-900'">
                        PLAY SEQUENCE
                    </button>
                    <button (click)="stopSequence()" class="px-4 py-2 border hover:bg-white/10" [class]="'border-' + theme().neutral + '-600'">STOP</button>
                    <button (click)="sequencerClips.set([])" class="px-4 py-2 border hover:bg-white/10" [class]="'border-' + theme().neutral + '-600'">CLEAR</button>
                </div>

                <div class="flex gap-1 overflow-x-auto pb-2">
                    <div *ngFor="let clip of sequencerClips(); let i = index"
                         class="flex-shrink-0 w-24 h-16 bg-black border relative group cursor-pointer"
                         [class]="currentSequenceIndex() === i ? 'border-white border-2' : 'border-' + theme().neutral + '-700'">
                        <video [src]="clip.url" class="w-full h-full object-cover opacity-50"></video>
                        <div class="absolute inset-0 flex items-center justify-center text-xs font-bold drop-shadow-md shadow-black">{{ i + 1 }}</div>
                        <button (click)="removeFromSequence(i)" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] w-4 h-4 flex items-center justify-center opacity-0 group-hover:opacity-100">x</button>
                    </div>
                    <div *ngIf="sequencerClips().length === 0" class="text-xs opacity-40 p-2">Drag clips here... (via + SEQ button)</div>
                </div>
            </div>
        </div>
      </div>
  </div>
</div>
